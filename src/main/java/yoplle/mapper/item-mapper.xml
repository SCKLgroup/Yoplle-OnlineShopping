<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="yoplle">
	<sql id="selectItem"> 
		SELECT
		ITEM_NO,EMP_NO,ITEM_NAME,ITEM_CATEGORY,ITEM_DE_CONTENT,ITEM_IMG,ITEM_PRICE,ITEM_ORIGIN,ITEM_EA,ITEM_STOCK,TO_CHAR(ITEM_DATE,'YYYY/MM/DD')ITEM_DATE
		FROM ITEM
	</sql>
	
	<select id="getTotalItem" parameterType="String" resultType="int"> <!-- 상품 수  -->
  		Select count(*) from item where ITEM_CATEGORY=#{value}
  	</select>
  	
	<select id="selectItemList" parameterType="HashMap" resultType="yoplle.vo.ItemVO"> <!-- 상품 리스트 -->
		SELECT * FROM
		(SELECT
			ITEM_NO,EMP_NO,ITEM_NAME,ITEM_CATEGORY,ITEM_DE_CONTENT,ITEM_IMG,ITEM_PRICE,ITEM_ORIGIN,ITEM_EA,ITEM_STOCK,TO_CHAR(ITEM_DATE,'YYYY/MM/DD')ITEM_DATE,
		<choose>
			<when test = "sort == 'lowCost'.toString()">
				ROW_NUMBER() OVER(ORDER BY ITEM_PRICE ASC) AS RNUM
			</when>
			<when test = "sort == 'highCost'.toString()">
				ROW_NUMBER() OVER(ORDER BY ITEM_PRICE DESC) AS RNUM
			</when>
			<otherwise>
				ROW_NUMBER() OVER(ORDER BY ITEM_DATE DESC) AS RNUM
			</otherwise>
		</choose>
		FROM ITEM
		WHERE ITEM_CATEGORY=#{category})
        WHERE RNUM BETWEEN ${start} AND ${end}
	</select>

 	<select id="selectInfoItem" parameterType="int" resultType="item"> <!-- 상품 상세 -->
		SELECT
		ITEM_NO,EMP_NO,ITEM_NAME,ITEM_CATEGORY,ITEM_DE_CONTENT,ITEM_IMG,ITEM_PRICE,ITEM_ORIGIN,ITEM_EA,ITEM_STOCK,TO_CHAR(ITEM_DATE,'YYYY/MM/DD')ITEM_DATE
		FROM ITEM
		WHERE
		ITEM_NO=#{no}
	</select>
	
	<select id="selectsearchItemList" parameterType="String" resultType="item"> <!-- 상품 검색 -->
		SELECT
		ITEM_NO,EMP_NO,ITEM_NAME,ITEM_CATEGORY,ITEM_DE_CONTENT,ITEM_IMG,ITEM_PRICE,ITEM_ORIGIN,ITEM_EA,ITEM_STOCK,TO_CHAR(ITEM_DATE,'YYYY/MM/DD')ITEM_DATE
		FROM ITEM
		WHERE
		ITEM_CA_DE LIKE '%'||#{VALUE}||'%'
	</select>
	
	<select id="recipeMatch" parameterType="int" resultType="yoplle.vo.ShopDeRecipeVO">  <!-- 상세 페이지 슬라이드 -->
		SELECT DISTINCT RP.RPE_NO, RP.RPE_TITLE, RP.RPE_IMG, U.USER_NAME FROM RECIPE RP, USERINFO U,
		(SELECT RI.RPE_NO FROM RECIPE_INGR RI, RECIPE R,
	    (SELECT ITEM_CA_DE FROM ITEM WHERE ITEM_NO=#{no}) X WHERE RI.INGR_NAME=X.ITEM_CA_DE) X WHERE RP.RPE_NO=X.RPE_NO AND U.USER_NO=RP.USER_NO
	</select>
	
	<select id="selectItemVolume" parameterType="HashMap" resultType="yoplle.vo.ItemVO">
		select i.ITEM_NO, i.ITEM_NAME, i.ITEM_CATEGORY, i.ITEM_IMG, i.ITEM_PRICE, i.vol, i.rnum from
		(select i.ITEM_NO, i.ITEM_NAME, i.ITEM_CATEGORY, i.ITEM_IMG, i.ITEM_PRICE, TO_CHAR(i.ITEM_DATE,'YYYY/MM/DD'), b.vol, ROW_NUMBER() OVER(ORDER BY vol desc nulls last) AS RNUM from 
		(select * from item i where item_category=#{category})i left outer join 
		(select sum(or_de_quan) vol, item_no from order_de group by item_no order by vol desc) b on i.item_no=b.item_no) i where i.rnum between ${start} AND ${end}
	</select>
	
	<!-- 11월 6일자 추가(관리자용 상품등록)-->
	<select id="getItemSequence" resultType="java.lang.Integer">
		SELECT
		ITEM_SEQ.NEXTVAL
		FROM DUAL
	</select>

	<insert id="insertItem" parameterType="yoplle.vo.ItemVO">
		INSERT INTO
		ITEM(item_no,emp_no,item_name,item_category,item_de_content,item_img,item_price,item_origin,item_ea,item_stock,item_date,item_ca_de)
		VALUES(item_seq.nextval,1,#{item_name},#{item_category},#{item_de_content},#{item_img},#{item_price},#{item_origin},#{item_ea},#{item_stock},SYSDATE,#{item_ca_de})
	</insert>
	
	<select id="countItemAction" parameterType="HashMap" resultType="int">
		<choose>
			<when test='job neq "default".toString()'>
 		select count(*) from item
			where item_category=#{job}
			</when>
 		<otherwise>
		select count(*) from item
		</otherwise>
		</choose>
	</select>
	
	<delete id="deleteItemAction" parameterType="HashMap">
		delete from item where item_no in
		<foreach collection="no" item="no" open="(" close=")" separator=",">
		 	#{no}
		</foreach>
	</delete>

	<select id="selectItemAdminCate" resultType="yoplle.vo.ItemVO" parameterType="HashMap">
		SELECT
		ITEM_NO,EMP_NO,ITEM_NAME,ITEM_CATEGORY,ITEM_DE_CONTENT,ITEM_IMG,ITEM_PRICE,ITEM_ORIGIN,ITEM_EA,ITEM_STOCK,TO_CHAR(ITEM_DATE,'YYYY/MM/DD')ITEM_DATE
		FROM ITEM WHERE ITEM_CATEGORY=#{job}
	</select>
	
	<select id="allSelectItem" resultType="yoplle.vo.ItemVO">
		SELECT
		ITEM_NO,EMP_NO,ITEM_NAME,ITEM_CATEGORY,ITEM_DE_CONTENT,ITEM_IMG,ITEM_PRICE,ITEM_ORIGIN,ITEM_EA,ITEM_STOCK,TO_CHAR(ITEM_DATE,'YYYY/MM/DD')ITEM_DATE
		FROM ITEM
	</select>
	
	<select id="selectItemCategory" parameterType="String" resultType="item"> 
		SELECT
		ITEM_NO,EMP_NO,ITEM_NAME,ITEM_CATEGORY,ITEM_DE_CONTENT,ITEM_IMG,ITEM_PRICE,ITEM_ORIGIN,ITEM_EA,ITEM_STOCK,TO_CHAR(ITEM_DATE,'YYYY/MM/DD')ITEM_DATE
		FROM ITEM
		WHERE ITEM_CATEGORY= #{value}
	</select>  
	
</mapper>
